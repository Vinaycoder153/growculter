<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkTracker - Time & Money Management</title>
    <!-- Fonts: Noto Sans for multilingual support -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Icons: FontAwesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --radius: 0.5rem;
            --font-family: 'Noto Sans', sans-serif;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-hover: #60a5fa;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --border: #374151;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
        }

        /* --- GLOBAL STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- UTILITIES --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .p-4 { padding: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; font-weight: bold; }
        .text-muted { color: var(--text-muted); }
        .text-warning { color: var(--warning); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .w-full { width: 100%; }
        
        /* --- COMPONENTS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
            font-size: 0.875rem;
            gap: 0.5rem;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-outline { border-color: var(--border); background: transparent; color: var(--text-main); }
        .btn-outline:hover { background-color: var(--bg-body); border-color: var(--text-muted); }
        .btn-danger { background-color: var(--danger); color: white; }
        
        .card {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-muted); }
        .form-control {
            width: 100%;
            padding: 0.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: inherit;
        }
        .form-control:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* --- LAYOUTS --- */
        /* Auth Screen */
        #auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .auth-box { width: 100%; max-width: 400px; }

        /* Dashboard */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            background-color: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem; }
        .nav-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: var(--radius);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .nav-item:hover, .nav-item.active { background-color: var(--bg-body); color: var(--primary); }

        /* Main Content */
        .main-content { padding: 2rem; overflow-y: auto; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; margin-top: 0.5rem; }

        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); }
        th { color: var(--text-muted); font-weight: 600; }
        tr:hover { background-color: var(--bg-body); }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-done { background-color: #d1fae5; color: #065f46; }
        .status-pending { background-color: #fef3c7; color: #92400e; }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: var(--bg-card);
            padding: 2rem;
            border-radius: var(--radius);
            width: 100%; max-width: 600px;
            max-height: 90vh; overflow-y: auto;
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .dashboard-layout { grid-template-columns: 1fr; }
            .sidebar { display: none; } /* Simplified mobile handling */
            .sidebar.mobile-open { display: flex; position: fixed; top: 0; left: 0; bottom: 0; width: 80%; z-index: 100; box-shadow: var(--shadow); }
            .mobile-toggle { display: block; }
        }
        @media (min-width: 769px) { .mobile-toggle { display: none; } }

        /* Print Layout */
        @media print {
            .sidebar, .mobile-toggle, .btn-primary, .btn-outline, .header-actions { display: none !important; }
            .dashboard-layout { display: block; }
            .main-content { padding: 0; }
            .card { box-shadow: none; border: none; }
            table { width: 100%; border: 1px solid #ccc; }
        }

        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--text-main); color: var(--bg-card);
            padding: 10px 20px; border-radius: var(--radius);
            box-shadow: var(--shadow); z-index: 200;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <!-- --- APP CONTAINER --- -->
    <div id="app"></div>

    <!-- --- TEMPLATES (Hidden) --- -->
    
    <!-- Auth Template -->
    <template id="tpl-auth">
        <div id="auth-screen">
            <div class="card auth-box">
                <div class="text-center" style="text-align: center; margin-bottom: 1.5rem;">
                    <i class="fa-solid fa-wallet fa-2x" style="color: var(--primary);"></i>
                    <h2 class="text-lg mt-4" data-i18n="appName">WorkTracker</h2>
                </div>
                <form id="login-form">
                    <div class="input-group">
                        <label for="username" data-i18n="username">Username</label>
                        <input type="text" id="username" aria-label="Username" class="form-control" required placeholder="admin">
                    </div>
                    <div class="input-group">
                        <label for="password" data-i18n="password">Password</label>
                        <input type="password" id="password" aria-label="Password" class="form-control" required placeholder="password123">
                    </div>
                    <button type="submit" class="btn btn-primary w-full" data-i18n="login">Login</button>
                    <p class="text-sm text-center mt-4 text-muted">
                        Try: <b>admin</b>, <b>user</b>, or <b>middleman</b><br>
                        Pass: <b>password123</b>
                    </p>
                </form>
            </div>
        </div>
    </template>

    <!-- Dashboard Shell -->
    <template id="tpl-dashboard">
        <div class="dashboard-layout">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="logo">
                    <i class="fa-solid fa-wallet"></i> <span data-i18n="appName">WorkTracker</span>
                </div>
                <nav>
                    <div class="nav-item active" onclick="app.router.navigate('home')">
                        <i class="fa-solid fa-chart-line"></i> <span data-i18n="navHome">Overview</span>
                    </div>
                    <div class="nav-item" onclick="app.router.navigate('entries')">
                        <i class="fa-solid fa-list"></i> <span data-i18n="navEntries">Work Entries</span>
                    </div>
                    <div class="nav-item role-admin" onclick="app.router.navigate('users')">
                        <i class="fa-solid fa-users"></i> <span data-i18n="navUsers">Users</span>
                    </div>
                    <div class="nav-item" onclick="app.router.navigate('settings')">
                        <i class="fa-solid fa-gear"></i> <span data-i18n="navSettings">Settings</span>
                    </div>
                </nav>
                <div style="margin-top: auto;">
                    <button class="btn btn-outline w-full" onclick="app.auth.logout()">
                        <i class="fa-solid fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <header class="header-bar">
                    <div class="flex items-center gap-4">
                        <button class="btn btn-outline mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('mobile-open')">
                            <i class="fa-solid fa-bars"></i>
                        </button>
                        <h2 class="text-lg" id="page-title">Dashboard</h2>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-outline" onclick="app.ui.toggleTheme()">
                            <i class="fa-solid fa-moon"></i>
                        </button>
                        <select class="form-control" style="width: auto;" onchange="app.i18n.setLang(this.value)" id="lang-select">
                            <option value="en">English</option>
                            <option value="kn">ಕನ್ನಡ</option>
                            <option value="hi">हिंदी</option>
                            <option value="ta">தமிழ்</option>
                        </select>
                        <div class="text-sm font-bold" id="user-display-name">User</div>
                    </div>
                </header>
                
                <div id="view-container">
                    <!-- Dynamic View Content -->
                </div>
            </main>
        </div>
    </template>

    <!-- Modal Template -->
    <template id="tpl-modal">
        <div class="modal-overlay hidden" id="modal-overlay">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg" id="modal-title">Title</h3>
                    <button class="btn btn-outline" onclick="app.ui.closeModal()">✕</button>
                </div>
                <div id="modal-body"></div>
            </div>
        </div>
    </template>

    <!-- SCRIPTS -->
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js"></script>
    
    <script>
        /**
         * 1. MATH UTILS
         * Precise floating point arithmetic by converting to integers (cents)
         */
        const MathUtils = {
            toCents: (amount) => Math.round(parseFloat(amount || 0) * 100),
            fromCents: (cents) => (cents / 100).toFixed(2),
            multiply: (cents, multiplier) => Math.round(cents * multiplier),
            calcPct: (cents, percent) => Math.round(cents * (percent / 100)),
            
            // Format currency based on locale
            formatMoney: (cents) => {
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency', currency: 'INR'
                }).format(cents / 100);
            },

            // Duration in hours (decimal)
            getDuration: (startStr, endStr) => {
                if(!startStr || !endStr) return 0;
                const start = new Date(startStr);
                const end = new Date(endStr);
                const diffMs = end - start;
                return Math.max(0, diffMs / (1000 * 60 * 60)); // Hours
            }
        };

        /**
         * 2. I18N DATA & ENGINE
         */
        const Locales = {
            en: {
                appName: "WorkTracker",
                username: "Username",
                password: "Password",
                login: "Login",
                navHome: "Overview",
                navEntries: "Work Entries",
                navUsers: "Users",
                navSettings: "Settings",
                logout: "Logout",
                totalEarned: "Total Earned",
                totalDue: "Outstanding Due",
                commissionPaid: "Commission Paid",
                entriesList: "Work Entries List",
                newEntry: "New Entry",
                exportCSV: "Export CSV",
                printPDF: "Print Report",
                calcTool: "Time Calculator",
                title: "Job Title",
                client: "Client",
                status: "Status",
                amount: "Amount",
                actions: "Actions",
                statusDone: "Done",
                statusPending: "In Progress",
                save: "Save",
                cancel: "Cancel",
                calc: "Calculate",
                desc: "Description",
                rate: "Hourly Rate / Fixed",
                hours: "Hours",
                notes: "Notes",
                error: "Error",
                success: "Success",
                deleteConfirm: "Are you sure?",
                middleman: "Middleman",
                received: "Received"
            },
            kn: {
                appName: "ವರ್ಕ್ ಟ್ರ್ಯಾಕರ್",
                username: "ಬಳಕೆದಾರ ಹೆಸರು",
                password: "ಗುಪ್ತಪದ",
                login: "ಲಾಗಿನ್",
                navHome: "ಅವಲೋಕನ",
                navEntries: "ಕೆಲಸದ ನಮೂದುಗಳು",
                navUsers: "ಬಳಕೆದಾರರು",
                navSettings: "ಸೆಟ್ಟಿಂಗ್‌ಗಳು",
                logout: "ಲಾಗ್ ಔಟ್",
                totalEarned: "ಗಳಿಸಿದ ಒಟ್ಟು ಮೊತ್ತ",
                totalDue: "ಬಾಕಿ ಉಳಿದಿದೆ",
                commissionPaid: "ಕಮಿಷನ್ ಪಾವತಿಸಲಾಗಿದೆ",
                entriesList: "ಕೆಲಸದ ಪಟ್ಟಿ",
                newEntry: "ಹೊಸ ನಮೂದು",
                exportCSV: "CSV ರಫ್ತು",
                printPDF: "ವರದಿ ಮುದ್ರಿಸಿ",
                calcTool: "ಸಮಯ ಕ್ಯಾಲ್ಕುಲೇಟರ್",
                title: "ಕೆಲಸದ ಶೀರ್ಷಿಕೆ",
                client: "ಗ್ರಾಹಕ",
                status: "ಸ್ಥಿತಿ",
                amount: "ಮೊತ್ತ",
                actions: "ಕ್ರಿಯೆಗಳು",
                statusDone: "ಮುಗಿದಿದೆ",
                statusPending: "ಪ್ರಗತಿಯಲ್ಲಿದೆ",
                save: "ಉಳಿಸಿ",
                cancel: "ರದ್ದುಮಾಡಿ",
                calc: "ಲೆಕ್ಕಾಚಾರ",
                desc: "ವಿವರಣೆ",
                rate: "ದರ",
                hours: "ಗಂಟೆಗಳು",
                notes: "ಟಿಪ್ಪಣಿಗಳು",
                middleman: "ಮಧ್ಯವರ್ತಿ",
                received: "ಸ್ವೀಕರಿಸಲಾಗಿದೆ"
            },
            hi: {
                appName: "वर्क ट्रैकर",
                username: "उपयोगकर्ता नाम",
                password: "पासवर्ड",
                login: "लॉग इन",
                navHome: "अवलोकन",
                navEntries: "कार्य प्रविष्टियाँ",
                navUsers: "उपयोगकर्ता",
                navSettings: "समायोजन",
                logout: "लॉग आउट",
                totalEarned: "कुल कमाई",
                totalDue: "बकाया राशि",
                commissionPaid: "कमीशन भुगतान",
                entriesList: "कार्य सूची",
                newEntry: "नई प्रविष्टि",
                exportCSV: "CSV निर्यात",
                printPDF: "प्रिंट रिपोर्ट",
                calcTool: "समय कैलकुलेटर",
                title: "शीर्षक",
                client: "ग्राहक",
                status: "स्थिति",
                amount: "राशि",
                actions: "क्रियाएं",
                statusDone: "पूर्ण",
                statusPending: "प्रगति में",
                save: "सहेजें",
                cancel: "रद्द करें",
                calc: "गणना",
                desc: "विवरण",
                rate: "दर",
                hours: "घंटे",
                notes: "नोट्स",
                middleman: "बिचौलिया",
                received: "प्राप्त किया"
            },
            ta: {
                appName: "வொர்க் டிராக்கர்",
                username: "பயனர் பெயர்",
                password: "கடவுச்சொல்",
                login: "உள்நுழைய",
                navHome: "கண்ணோட்டம்",
                navEntries: "வேலை உள்ளீடுகள்",
                navUsers: "பயனர்கள்",
                navSettings: "அமைப்புகள்",
                logout: "வெளியேறு",
                totalEarned: "மொத்த வருவாய்",
                totalDue: "நிலுவையில் உள்ளது",
                commissionPaid: "கமிஷன் வழங்கப்பட்டது",
                entriesList: "வேலை பட்டியல்",
                newEntry: "புதிய பதிவு",
                exportCSV: "CSV ஏற்றுமதி",
                printPDF: "அறிக்கை அச்சிடு",
                calcTool: "நேர கால்குலேட்டர்",
                title: "தலைப்பு",
                client: "வாடிக்கையாளர்",
                status: "நிலை",
                amount: "தொகை",
                actions: "செயல்கள்",
                statusDone: "முடிந்தது",
                statusPending: "செயலில்",
                save: "சேமி",
                cancel: "ரத்துசெய்",
                calc: "கணக்கிடு",
                desc: "விளக்கம்",
                rate: "விகிதம்",
                hours: "மணிநேரம்",
                notes: "குறிப்புகள்",
                middleman: "இடைத்தரகர்",
                received: "பெறப்பட்டது"
            }
        };

        /**
         * 3. FIREBASE CONFIG & INIT
         */
        const firebaseConfig = {
            apiKey: "AIzaSyCAtAPyouHyaBPJdv02M9dipOU4ZunbuQM",
            authDomain: "ganesha-bc91a.firebaseapp.com",
            databaseURL: "https://ganesha-bc91a-default-rtdb.firebaseio.com",
            projectId: "ganesha-bc91a",
            storageBucket: "ganesha-bc91a.firebasestorage.app",
            messagingSenderId: "766383565356",
            appId: "1:766383565356:web:21479e986035f99e817f89",
            measurementId: "G-H5KNBX1Q4K"
        };
        
        firebase.initializeApp(firebaseConfig);
        const firebaseAuth = firebase.auth();
        const firebaseDB = firebase.database();

        /**
         * 4. MOCK DATABASE & SEED DATA
         */
        const DB_KEY = 'worktracker_db_v1';
        
        const SeedData = {
            users: [
                { id: 1, username: 'admin', password: 'password123', role: 'admin', name: 'Admin User' },
                { id: 2, username: 'middleman', password: 'password123', role: 'middleman', name: 'Mr. Agent' },
                { id: 3, username: 'user', password: 'password123', role: 'user', name: 'John Doe' },
                { id: 4, username: 'user2', password: 'password123', role: 'user', name: 'Jane Smith' }
            ],
            entries: [
                { id: 101, userId: 3, middlemanId: 2, title: 'Website Design', client: 'Acme Corp', start: '2023-10-01T09:00', end: '2023-10-01T17:00', type: 'fixed', rate: 50000, amountAgreed: 5000000, amountReceived: 2500000, status: 'pending', commissionPct: 10, notes: 'Half paid upfront', createdAt: new Date().toISOString() },
                { id: 102, userId: 3, middlemanId: null, title: 'Logo Fix', client: 'Beta LLC', start: '2023-10-02T10:00', end: '2023-10-02T12:00', type: 'hourly', rate: 2000, amountAgreed: 400000, amountReceived: 400000, status: 'done', commissionPct: 0, notes: 'Quick fix', createdAt: new Date().toISOString() },
                { id: 103, userId: 4, middlemanId: 2, title: 'SEO Audit', client: 'Gamma Inc', start: '2023-10-05T09:00', end: '2023-10-05T13:00', type: 'fixed', rate: 15000, amountAgreed: 1500000, amountReceived: 0, status: 'pending', commissionPct: 15, notes: 'Waiting for payment', createdAt: new Date().toISOString() }
            ]
        };

        const DB = {
            data: null,
            init: function() {
                const stored = localStorage.getItem(DB_KEY);
                if (stored) {
                    this.data = JSON.parse(stored);
                } else {
                    this.reset();
                }
            },
            reset: function() {
                this.data = JSON.parse(JSON.stringify(SeedData)); // Deep copy
                this.save();
            },
            save: function() {
                localStorage.setItem(DB_KEY, JSON.stringify(this.data));
            },
            // API Methods - Firebase Auth
            login: async function(email, password) {
                try {
                    const result = await firebaseAuth.signInWithEmailAndPassword(email, password);
                    const user = result.user;
                    // Fetch user profile from Realtime DB
                    const snapshot = await firebaseDB.ref('users/' + user.uid).once('value');
                    const profile = snapshot.val() || {};
                    return {
                        id: user.uid,
                        username: email.split('@')[0],
                        email: user.email,
                        name: profile.name || 'User',
                        role: profile.role || 'user'
                    };
                } catch (error) {
                    throw new Error(error.message || "Invalid credentials");
                }
            },
            logout: async function() {
                await firebaseAuth.signOut();
            },
            getEntries: function(user) {
                if (user.role === 'admin') return this.data.entries;
                if (user.role === 'middleman') return this.data.entries.filter(e => e.middlemanId === user.id);
                return this.data.entries.filter(e => e.userId === user.id);
            },
            saveEntry: function(entry) {
                if (entry.id) {
                    const idx = this.data.entries.findIndex(e => e.id === entry.id);
                    if (idx !== -1) this.data.entries[idx] = entry;
                } else {
                    entry.id = Date.now();
                    entry.createdAt = new Date().toISOString();
                    this.data.entries.push(entry);
                }
                this.save();
            },
            deleteEntry: function(id) {
                this.data.entries = this.data.entries.filter(e => e.id !== id);
                this.save();
            },
            getUsers: function() {
                return this.data.users.map(({password, ...u}) => u);
            }
        };

        /**
         * 5. APP CORE
         */
        const app = {
            currentUser: null,
            lang: 'en',
            
            init: function() {
                DB.init();
                this.checkSession();
                this.ui.render();
            },

            checkSession: function() {
                const sess = sessionStorage.getItem('wt_session');
                if (sess) {
                    this.currentUser = JSON.parse(sess);
                    this.router.navigate('home');
                } else {
                    this.router.navigate('login');
                }
            },

            i18n: {
                t: function(key) {
                    return Locales[app.lang][key] || key;
                },
                setLang: function(lang) {
                    app.lang = lang;
                    document.documentElement.lang = lang;
                    // Re-render current page to apply translations
                    app.ui.translatePage();
                }
            },

            auth: {
                login: async function(e) {
                    e.preventDefault();
                    const email = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    try {
                        const user = await DB.login(email, password);
                        app.currentUser = user;
                        sessionStorage.setItem('wt_session', JSON.stringify(user));
                        app.ui.toast("Welcome " + user.name, "success");
                        app.router.navigate('home');
                    } catch (err) {
                        app.ui.toast(err.message || "Login failed", "error");
                    }
                },
                logout: async function() {
                    try {
                        await DB.logout();
                        app.currentUser = null;
                        sessionStorage.removeItem('wt_session');
                        app.router.navigate('login');
                        app.ui.toast("Logged out", "success");
                    } catch (err) {
                        app.ui.toast("Logout failed", "error");
                    }
                }
            },

            router: {
                currentRoute: null,
                navigate: function(route) {
                    this.currentRoute = route;
                    const appEl = document.getElementById('app');
                    
                    if (route === 'login') {
                        const tpl = document.getElementById('tpl-auth').content.cloneNode(true);
                        appEl.innerHTML = '';
                        appEl.appendChild(tpl);
                        document.getElementById('login-form').onsubmit = app.auth.login;
                        app.ui.translatePage();
                        return;
                    }

                    // For Dashboard Routes
                    if (!document.querySelector('.dashboard-layout')) {
                        const tpl = document.getElementById('tpl-dashboard').content.cloneNode(true);
                        appEl.innerHTML = '';
                        appEl.appendChild(tpl);
                        // Append Modal Shell
                        const modalTpl = document.getElementById('tpl-modal').content.cloneNode(true);
                        appEl.appendChild(modalTpl);
                    }

                    // Update UI state
                    document.getElementById('user-display-name').innerText = app.currentUser.name;
                    document.getElementById('lang-select').value = app.lang;
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    // Highlight active nav
                    const navs = { home: 0, entries: 1, users: 2, settings: 3 };
                    const navEls = document.querySelectorAll('.nav-item');
                    if (navEls[navs[route]]) navEls[navs[route]].classList.add('active');

                    // Role Guard for sidebar
                    if (app.currentUser.role !== 'admin') {
                        document.querySelectorAll('.role-admin').forEach(el => el.style.display = 'none');
                    }

                    // Render Sub-view
                    const container = document.getElementById('view-container');
                    container.innerHTML = ''; // clear
                    
                    if (route === 'home') app.controllers.dashboard(container);
                    else if (route === 'entries') app.controllers.entries(container);
                    else if (route === 'users') app.controllers.users(container);
                    else if (route === 'settings') app.controllers.settings(container);

                    app.ui.translatePage();
                    
                    // Close mobile sidebar on nav
                    document.getElementById('sidebar').classList.remove('mobile-open');
                }
            },

            controllers: {
                dashboard: function(container) {
                    const entries = DB.getEntries(app.currentUser);
                    
                    // Calculations
                    let totalAgreed = 0;
                    let totalReceived = 0;
                    let commission = 0;

                    entries.forEach(e => {
                        totalAgreed += e.amountAgreed;
                        totalReceived += e.amountReceived;
                        if (e.commissionPct > 0) {
                            commission += MathUtils.calcPct(e.amountReceived, e.commissionPct);
                        }
                    });

                    const due = totalAgreed - totalReceived;

                    const html = `
                        <div class="stats-grid">
                            <div class="card stat-card">
                                <div class="text-muted" data-i18n="totalEarned">Total Earned</div>
                                <div class="stat-value text-success">${MathUtils.formatMoney(totalReceived)}</div>
                            </div>
                            <div class="card stat-card">
                                <div class="text-muted" data-i18n="totalDue">Outstanding</div>
                                <div class="stat-value text-danger">${MathUtils.formatMoney(due)}</div>
                            </div>
                            <div class="card stat-card">
                                <div class="text-muted" data-i18n="commissionPaid">Commission</div>
                                <div class="stat-value text-warning">${MathUtils.formatMoney(commission)}</div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="text-lg mb-4" data-i18n="entriesList">Recent Activity</h3>
                            ${app.ui.components.entryTable(entries.slice(0, 5))} <!-- Show last 5 -->
                        </div>
                    `;
                    container.innerHTML = html;
                },

                entries: function(container) {
                    const entries = DB.getEntries(app.currentUser);
                    
                    const html = `
                        <div class="flex justify-between items-center mb-4 header-actions">
                            <div class="flex gap-2">
                                <button class="btn btn-primary" onclick="app.ui.modals.entry()">
                                    <i class="fa-solid fa-plus"></i> <span data-i18n="newEntry">New</span>
                                </button>
                                <button class="btn btn-outline" onclick="app.ui.modals.calculator()">
                                    <i class="fa-solid fa-calculator"></i> <span data-i18n="calcTool">Calc</span>
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-outline" onclick="app.utils.exportCSV()">
                                    <i class="fa-solid fa-file-csv"></i> CSV
                                </button>
                                <button class="btn btn-outline" onclick="window.print()">
                                    <i class="fa-solid fa-print"></i> PDF
                                </button>
                            </div>
                        </div>
                        <div class="card">
                            ${app.ui.components.entryTable(entries, true)}
                        </div>
                    `;
                    container.innerHTML = html;
                },

                users: function(container) {
                    if (app.currentUser.role !== 'admin') return;
                    const users = DB.getUsers();
                    const html = `
                        <div class="card">
                            <h3 class="text-lg mb-4">User Management</h3>
                            <table class="w-full">
                                <thead><tr><th>ID</th><th>Username</th><th>Name</th><th>Role</th></tr></thead>
                                <tbody>
                                    ${users.map(u => `
                                        <tr>
                                            <td>${u.id}</td>
                                            <td>${u.username}</td>
                                            <td>${u.name}</td>
                                            <td><span class="status-badge status-done">${u.role}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.innerHTML = html;
                },

                settings: function(container) {
                    container.innerHTML = `
                        <div class="card">
                            <h3 class="text-lg mb-4" data-i18n="navSettings">Settings</h3>
                            <div class="input-group">
                                <label>Data Management</label>
                                <p class="text-sm text-muted mb-2">Reset database to initial seed data. Warning: Clears all your changes.</p>
                                <button class="btn btn-danger" onclick="if(confirm(app.i18n.t('deleteConfirm'))) { DB.reset(); location.reload(); }">
                                    Reset Data
                                </button>
                            </div>
                        </div>
                    `;
                }
            },

            ui: {
                render: function() {}, // placeholder
                
                toast: function(msg, type='success') {
                    const t = document.createElement('div');
                    t.className = 'toast';
                    t.style.borderLeft = '4px solid ' + (type === 'success' ? 'var(--success)' : 'var(--danger)');
                    t.innerText = msg;
                    document.body.appendChild(t);
                    setTimeout(() => t.remove(), 3000);
                },

                translatePage: function() {
                    document.querySelectorAll('[data-i18n]').forEach(el => {
                        const key = el.getAttribute('data-i18n');
                        el.innerText = app.i18n.t(key);
                    });
                },

                toggleTheme: function() {
                    const html = document.documentElement;
                    const current = html.getAttribute('data-theme');
                    html.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
                },

                openModal: function(title, bodyHtml) {
                    document.getElementById('modal-title').innerText = title;
                    document.getElementById('modal-body').innerHTML = bodyHtml;
                    document.getElementById('modal-overlay').classList.remove('hidden');
                    app.ui.translatePage();
                },
                
                closeModal: function() {
                    document.getElementById('modal-overlay').classList.add('hidden');
                },

                components: {
                    entryTable: function(entries, actions = false) {
                        if (!entries.length) return '<div class="p-4 text-center text-muted">No records found</div>';
                        return `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th data-i18n="title">Title</th>
                                        <th data-i18n="client">Client</th>
                                        <th data-i18n="amount">Amount</th>
                                        <th data-i18n="received">Received</th>
                                        <th data-i18n="status">Status</th>
                                        ${actions ? '<th data-i18n="actions">Actions</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${entries.map(e => `
                                        <tr>
                                            <td>
                                                <div style="font-weight:500">${e.title}</div>
                                                <div class="text-sm text-muted">${new Date(e.start).toLocaleDateString()}</div>
                                            </td>
                                            <td>${e.client}</td>
                                            <td>${MathUtils.formatMoney(e.amountAgreed)}</td>
                                            <td class="${e.amountReceived < e.amountAgreed ? 'text-danger' : 'text-success'}">
                                                ${MathUtils.formatMoney(e.amountReceived)}
                                            </td>
                                            <td>
                                                <span class="status-badge ${e.status === 'done' ? 'status-done' : 'status-pending'}">
                                                    ${app.i18n.t('status'+(e.status.charAt(0).toUpperCase() + e.status.slice(1)))}
                                                </span>
                                            </td>
                                            ${actions ? `
                                            <td>
                                                <button class="btn btn-outline" style="padding:0.25rem 0.5rem" onclick="app.ui.modals.entry(${e.id})">
                                                    <i class="fa-solid fa-pen"></i>
                                                </button>
                                                <button class="btn btn-outline text-danger" style="padding:0.25rem 0.5rem" onclick="app.utils.deleteEntry(${e.id})">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </td>
                                            ` : ''}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        `;
                    }
                },

                modals: {
                    entry: function(id = null) {
                        const entry = id ? DB.data.entries.find(e => e.id === id) : {};
                        const isEdit = !!id;
                        const users = DB.getUsers().filter(u => u.role === 'middleman');
                        
                        const html = `
                            <form id="entry-form">
                                <input type="hidden" name="id" value="${entry.id || ''}">
                                <div class="flex gap-4">
                                    <div class="input-group w-full">
                                        <label data-i18n="title">Title</label>
                                        <input type="text" name="title" aria-label="Title" class="form-control" value="${entry.title || ''}" required>
                                    </div>
                                    <div class="input-group w-full">
                                        <label data-i18n="client">Client</label>
                                        <input type="text" name="client" aria-label="Client" class="form-control" value="${entry.client || ''}" required>
                                    </div>
                                </div>
                                <div class="flex gap-4">
                                    <div class="input-group w-full">
                                        <label>Start</label>
                                        <input type="datetime-local" name="start" aria-label="Start" class="form-control" value="${entry.start || ''}" required>
                                    </div>
                                    <div class="input-group w-full">
                                        <label>End</label>
                                        <input type="datetime-local" name="end" aria-label="End" class="form-control" value="${entry.end || ''}">
                                    </div>
                                </div>
                                <div class="flex gap-4">
                                    <div class="input-group w-full">
                                        <label data-i18n="amount">Agreed Amount (Total)</label>
                                        <input type="number" step="0.01" id="amountInput" aria-label="Agreed Amount" class="form-control" value="${entry.amountAgreed ? MathUtils.fromCents(entry.amountAgreed) : ''}" required>
                                    </div>
                                    <div class="input-group w-full">
                                        <label data-i18n="received">Received Amount</label>
                                        <input type="number" step="0.01" id="receivedInput" aria-label="Received Amount" class="form-control" value="${entry.amountReceived ? MathUtils.fromCents(entry.amountReceived) : '0'}">
                                    </div>
                                </div>
                                <div class="flex gap-4">
                                    <div class="input-group w-full">
                                        <label data-i18n="status">Status</label>
                                        <select name="status" class="form-control">
                                            <option value="pending" ${entry.status === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="done" ${entry.status === 'done' ? 'selected' : ''}>Done</option>
                                        </select>
                                    </div>
                                    <div class="input-group w-full">
                                        <label data-i18n="middleman">Middleman</label>
                                        <select name="middlemanId" class="form-control">
                                            <option value="">None</option>
                                            ${users.map(u => `<option value="${u.id}" ${entry.middlemanId == u.id ? 'selected':''}>${u.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="input-group w-full">
                                        <label>Commission %</label>
                                        <input type="number" name="commissionPct" aria-label="Commission Percent" class="form-control" value="${entry.commissionPct || 0}">
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label data-i18n="notes">Notes</label>
                                    <textarea name="notes" class="form-control" rows="2">${entry.notes || ''}</textarea>
                                </div>
                                <div class="flex justify-between mt-4">
                                    <button type="button" class="btn btn-outline" onclick="app.ui.closeModal()" data-i18n="cancel">Cancel</button>
                                    <button type="submit" class="btn btn-primary" data-i18n="save">Save</button>
                                </div>
                            </form>
                        `;

                        app.ui.openModal(isEdit ? 'Edit Entry' : 'New Entry', html);

                        document.getElementById('entry-form').onsubmit = function(e) {
                            e.preventDefault();
                            const formData = new FormData(e.target);
                            const obj = Object.fromEntries(formData.entries());
                            
                            // Transform Data
                            obj.id = obj.id ? parseInt(obj.id) : null;
                            obj.userId = entry.userId || app.currentUser.id;
                            obj.middlemanId = obj.middlemanId ? parseInt(obj.middlemanId) : null;
                            obj.amountAgreed = MathUtils.toCents(document.getElementById('amountInput').value);
                            obj.amountReceived = MathUtils.toCents(document.getElementById('receivedInput').value);
                            obj.commissionPct = parseFloat(obj.commissionPct);

                            DB.saveEntry(obj);
                            app.ui.closeModal();
                            app.router.navigate('entries'); // refresh
                            app.ui.toast("Saved successfully");
                        };
                    },

                    calculator: function() {
                        const html = `
                            <div class="card p-4 mb-4" style="background:#f8fafc">
                                <div class="input-group">
                                    <label>Start Time</label>
                                    <input type="time" id="c-start" aria-label="Calculator Start Time" class="form-control" onchange="calcLogic()">
                                </div>
                                <div class="input-group">
                                    <label>End Time</label>
                                    <input type="time" id="c-end" aria-label="Calculator End Time" class="form-control" onchange="calcLogic()">
                                </div>
                                <div class="input-group">
                                    <label>Rate per Hour</label>
                                    <input type="number" id="c-rate" aria-label="Calculator Rate" class="form-control" placeholder="100.00" oninput="calcLogic()">
                                </div>
                                <hr class="my-4">
                                <div class="flex justify-between items-center">
                                    <div>Duration: <span id="c-dur" class="font-bold">0</span> hrs</div>
                                    <div>Total: <span id="c-total" class="font-bold text-lg text-success">0.00</span></div>
                                </div>
                            </div>
                        `;
                        app.ui.openModal(app.i18n.t('calcTool'), html);
                        
                        window.calcLogic = function() {
                            const start = document.getElementById('c-start').value;
                            const end = document.getElementById('c-end').value;
                            const rate = parseFloat(document.getElementById('c-rate').value) || 0;
                            
                            if (start && end) {
                                // Simple time diff for same day
                                const d1 = new Date("2000-01-01 " + start);
                                const d2 = new Date("2000-01-01 " + end);
                                let diff = (d2 - d1) / (1000 * 60 * 60);
                                if (diff < 0) diff += 24; // Handle overnight
                                
                                document.getElementById('c-dur').innerText = diff.toFixed(2);
                                document.getElementById('c-total').innerText = (diff * rate).toFixed(2);
                            }
                        };
                    }
                }
            },
            
            utils: {
                deleteEntry: function(id) {
                    if(confirm(app.i18n.t('deleteConfirm'))) {
                        DB.deleteEntry(id);
                        app.router.navigate('entries');
                        app.ui.toast("Deleted");
                    }
                },
                exportCSV: function() {
                    const entries = DB.getEntries(app.currentUser);
                    function esc(v) {
                        if (v === null || v === undefined) return '""';
                        return '"' + String(v).replace(/"/g, '""') + '"';
                    }
                    let csv = 'ID,Date,Client,Title,Amount Agreed,Amount Received,Status\n';
                    entries.forEach(e => {
                        const row = [
                            e.id,
                            e.start,
                            e.client,
                            e.title,
                            MathUtils.fromCents(e.amountAgreed),
                            MathUtils.fromCents(e.amountReceived),
                            e.status
                        ].map(esc).join(',');
                        csv += row + '\n';
                    });

                    const encodedUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
                    const link = document.createElement('a');
                    link.setAttribute('href', encodedUri);
                    link.setAttribute('download', 'work_entries.csv');
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                }
            }
        };

        // Boot
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>